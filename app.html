<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards de Ingl√©s - Estilo Duolingo V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Duolingo Inspired Palette (V2 - Darker Green) --- */
        :root {
            --duo-green: #4CAF50; /* Darker main green */
            --duo-green-dark: #388E3C; /* Darker border green */
            --duo-green-light: #66BB6A; /* Adjusted hover green */
            --duo-blue: #1cb0f6;
            --duo-blue-dark: #138bc4;
            --duo-red: #ff4b4b;
            --duo-red-dark: #fa2d2d;
            --duo-orange: #ff9600;
            --duo-orange-dark: #e88800;
            --duo-yellow: #ffc800;
            --duo-gray-lightest: #f7f7f7;
            --duo-gray-light: #e5e5e5;
            --duo-gray-medium: #afafaf;
            --duo-gray-dark: #777777;
            --duo-text-dark: #4b4b4b;
            --duo-text-light: #ffffff;
            --duo-correct-bg: #d7ffb8;
            --duo-correct-text: #58a700; /* Kept original correct green text for contrast */
            --duo-incorrect-bg: #ffdfe0;
            --duo-incorrect-text: #ea2b2b;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Nunito', sans-serif;
            background-color: var(--duo-gray-lightest);
            color: var(--duo-text-dark);
            overflow: hidden; /* Evitar scroll en el body en vista de escritorio */
        }
        .app-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            padding: 0.75rem; /* Main app padding */
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }
        .main-content-area {
            display: flex;
            width: 100%;
            max-width: 1200px;
            flex-grow: 1;
            gap: 1rem;
            overflow: hidden; /* Prevent this area from showing scrollbars if children are managed */
        }
        .left-column, .right-column {
            background-color: var(--duo-text-light);
            padding: 1.1rem; /* Slightly reduced column padding */
            border-radius: 1rem;
            border: 1px solid var(--duo-gray-light);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow-y: auto; /* Allow internal scroll IF content is still too tall */
            display: flex;
            flex-direction: column;
        }
        .left-column { width: 45%; }
        .right-column { width: 55%; }

        .column-title {
            font-size: 1.4rem; /* Slightly reduced */
            font-weight: 800;
            color: var(--duo-text-dark);
            text-align: center;
            margin-bottom: 0.75rem; /* Reduced */
            padding-bottom: 0.5rem; /* Reduced */
            border-bottom: 2px solid var(--duo-gray-light);
        }

        .app-header {
            margin-bottom: 0.25rem; /* Reduced header margin */
            text-align: center;
            width: 100%;
            max-width: 1200px;
            min-height: 5px;
        }

        /* Flashcards */
        #flashcard-section { margin-bottom: 0.75rem; } /* Reduced from mb-6 (1.5rem) to mb-3 (0.75rem) */
        .flashcard {
            background-color: var(--duo-text-light);
            border: 2px solid var(--duo-gray-light);
            padding: 1.1rem; /* Reduced */
            border-radius: 0.75rem;
            margin-bottom: 0.75rem; /* Reduced */
            min-height: 100px; /* Reduced */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        #question-text {
            font-size: 1.15rem; /* Reduced */
            font-weight: 700;
            color: var(--duo-text-dark);
        }
        .input-field { /* Flashcard input */
            padding: 0.6rem 0.9rem; /* Reduced */
            border: 2px solid var(--duo-gray-light);
            border-radius: 0.75rem;
            width: 100%;
            max-width: 280px; /* Slightly reduced max-width */
            margin: 0.375rem auto; /* Reduced */
            box-sizing: border-box;
            font-size: 0.9rem; /* Reduced */
            color: var(--duo-text-dark);
            transition: border-color 0.2s ease;
        }
        .input-field:focus {
            border-color: var(--duo-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(28, 176, 246, 0.2);
        }
        .feedback { /* Main feedback area */
            margin-top: 0.375rem; /* Reduced */
            font-weight: 700;
            min-height: 20px; /* Reduced */
            font-size: 0.85rem; /* Reduced */
            margin-bottom: 0.6rem; /* Reduced */
            padding: 0.4rem; /* Reduced */
            border-radius: 0.5rem;
            text-align: center;
        }
        .feedback.correct {
            background-color: var(--duo-correct-bg);
            color: var(--duo-correct-text);
            border: 1px solid var(--duo-correct-text);
        }
        .feedback.incorrect {
            background-color: var(--duo-incorrect-bg);
            color: var(--duo-incorrect-text);
            border: 1px solid var(--duo-incorrect-text);
        }
         .feedback.info {
            background-color: #e0f2fe;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Buttons - Duolingo Style */
        .btn {
            padding: 0.65rem 1.1rem; /* Reduced */
            border-radius: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
            cursor: pointer;
            border: none;
            border-bottom: 3px solid rgba(0,0,0,0.2);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 90px; /* Reduced */
            font-size: 0.85rem; /* Reduced */
            color: var(--duo-text-light);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn:active {
            transform: translateY(0px);
            border-bottom-width: 1px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn-primary { background-color: var(--duo-green); border-bottom-color: var(--duo-green-dark); }
        .btn-primary:hover { background-color: var(--duo-green-light); }

        .btn-secondary { background-color: var(--duo-blue); border-bottom-color: var(--duo-blue-dark); }
        .btn-secondary:hover { background-color: #4acaff; }

        .btn-tertiary { background-color: var(--duo-orange); border-bottom-color: var(--duo-orange-dark); }
        .btn-tertiary:hover { background-color: #ffae40; }

        .btn-danger { background-color: var(--duo-red); border-bottom-color: var(--duo-red-dark); }
        .btn-danger:hover { background-color: #ff6a6a; }

        .btn-learned { background-color: var(--duo-yellow); border-bottom-color: #e6b400; color: var(--duo-text-dark); }
        .btn-learned:hover { background-color: #ffd433; }

        .btn-disabled {
            background-color: var(--duo-gray-light);
            border-bottom-color: var(--duo-gray-medium);
            color: var(--duo-gray-dark);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05);
        }
        .btn-disabled:hover { background-color: var(--duo-gray-light); }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); /* Reduced minmax */
            gap: 0.5rem; /* Reduced */
            margin-bottom: 0.75rem; /* Reduced from mb-6 */
        }
        .stat-item {
            background-color: var(--duo-gray-lightest);
            padding: 0.6rem; /* Reduced */
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid var(--duo-gray-light);
        }
        .stat-item h3 {
            margin-top: 0;
            color: var(--duo-gray-dark);
            font-size: 0.7rem; /* Reduced */
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.1rem; /* Added small margin */
        }
        .stat-item p { font-size: 1.1rem; font-weight: 700; color: var(--duo-text-dark); } /* Reduced */
        #open-shop-btn { font-size: 0.75rem !important; padding: 0.5rem 0.9rem !important; } /* Reduced */

        /* Tree */
        .tree-section-container { display: flex; flex-direction: column; flex-grow: 1; }
        .tree-display {
            margin: 0.5rem 0; /* Reduced */
            min-height: 130px; /* Reduced */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease-in-out;
            flex-grow: 1; /* Allow tree display to take up available space */
        }
        .tree-display:hover { transform: scale(1.05); }
        .tree-gif { max-width: 100%; max-height: 180px; object-fit: contain; } /* Reduced max-height */
        #tree-level-text {
            font-size: 0.9rem; /* Reduced */
            margin-top: 0.25rem; /* Reduced */
            font-weight: 600;
            color: var(--duo-gray-dark);
        }

        /* Section Titles & Button Groups */
        .section-title {
            font-size: 1.1rem; /* Reduced */
            font-weight: 700;
            margin-bottom: 0.6rem; /* Reduced */
            text-align: center;
            color: var(--duo-text-dark);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.4rem; /* Reduced */
        }
        .button-group .btn { /* Buttons within groups */
            font-size: 0.75rem; /* Reduced */
            padding: 0.5rem 0.9rem; /* Reduced */
        }
        .bottom-section { /* Sections at the bottom of columns */
            margin-top: auto; /* Pushes to bottom */
            padding-top: 0.6rem; /* Reduced */
            border-top: 1px solid var(--duo-gray-light);
        }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%; max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-top: 5px solid var(--duo-green); /* Uses new darker green */
        }
        .modal-content h3 {
            font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; color: var(--duo-text-dark);
            text-align: center;
        }
        .modal-content label {
            font-size: 0.9rem; color: var(--duo-gray-dark); margin-bottom: 0.25rem; display: block; font-weight: 600;
        }
        .modal-content .input-field { font-size: 0.9rem; margin-bottom: 1rem; }
        .modal-content .feedback { font-size: 0.8rem; min-height: 20px; }
        .modal-content .btn-sm {
            font-size: 0.85rem;
            padding: 0.6rem 1rem;
            text-transform: uppercase;
        }
        .modal-content .btn.bg-slate-300 {
            background-color: var(--duo-gray-light);
            color: var(--duo-gray-dark);
            border-bottom-color: var(--duo-gray-medium);
        }
        .modal-content .btn.bg-slate-300:hover {
            background-color: #d1d1d1;
        }

        #import-progress-input { display: none; }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            html, body { overflow: auto; height: auto; }
            .app-wrapper { height: auto; padding: 0.5rem; z-index: auto; }
            .main-content-area { flex-direction: column; overflow-y: visible; }
            .left-column, .right-column { width: 100%; max-height: none; margin-bottom: 1rem; overflow-y: visible; }
            .left-column:last-child, .right-column:last-child { margin-bottom: 0; }
            .tree-gif { max-height: 180px; } /* Keep a decent size for tablet */
        }

        @media (max-width: 640px) {
            .app-wrapper { padding: 0.25rem; }
            .left-column, .right-column { padding: 0.75rem; } /* Reduced padding for small mobile */
            .flashcard { padding: 0.75rem; min-height: 90px; }
            #question-text { font-size: 1rem; } /* Slightly smaller on smallest screens */
            .tree-gif { max-height: 130px; }
            .btn { padding: 0.5rem 0.8rem; font-size: 0.75rem; min-width: 70px; } /* Smaller buttons for mobile */
            .button-group .btn { font-size: 0.7rem; padding: 0.4rem 0.7rem;}
            .input-field { font-size: 0.85rem; padding: 0.5rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.375rem; }
            .stat-item h3 { font-size: 0.65rem; }
            .stat-item p { font-size: 1rem; }
            .section-title { font-size: 1rem; }
            .modal-content { padding: 1rem; width: 95%; }
            .modal-content h3 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <header class="app-header">
            </header>

        <div class="main-content-area">
            <div class="left-column">
                <h2 class="column-title">Panel de Estudio</h2>
                <section id="flashcard-section"> 
                    <div class="flashcard">
                        <p id="question-text"></p>
                    </div>
                    <input type="text" id="answer-input" class="input-field mx-auto block" placeholder="Escribe la traducci√≥n...">
                    <div id="feedback-text" class="feedback text-center"></div> 
                    <div class="flex justify-center space-x-2 mt-1.5 button-group"> 
                        <button id="check-answer-btn" class="btn btn-primary">Revisar</button>
                        <button id="learned-btn" class="btn btn-learned hidden">¬°Lo s√©!</button>
                        <button id="next-card-btn" class="btn btn-secondary hidden">Siguiente</button>
                    </div>
                </section>

                <section class="stats-grid"> 
                    <div class="stat-item">
                        <h3>Puntos</h3>
                        <p id="score">0</p>
                    </div>
                    <div class="stat-item">
                        <h3>Fertilizante</h3>
                        <p id="fertilizer-count">0</p>
                    </div>
                    <div class="stat-item">
                        <h3>Manzanas</h3>
                        <p id="apples-count">0 üçé</p>
                    </div>
                     <div class="stat-item">
                        <h3>Producci√≥n</h3>
                        <p id="apples-per-day" class="text-xs sm:text-sm">0 / d√≠a</p> </div>
                    <div class="stat-item">
                        <h3>Pr√≥ximas üçé</h3>
                        <p id="apple-countdown" class="text-xs sm:text-sm">--:--:--</p> </div>
                    <div class="stat-item col-span-full">
                        <button id="open-shop-btn" class="btn btn-tertiary mt-0.5 w-full">Tienda</button> </div>
                </section>

                <section class="bottom-section">
                    <h2 class="section-title text-[var(--duo-blue)]">Gestionar Palabras</h2>
                    <div class="button-group">
                         <button id="show-add-card-modal-btn" class="btn btn-primary">A√±adir</button>
                         <button id="show-delete-card-modal-btn" class="btn btn-danger">Eliminar</button>
                         <button id="show-review-learned-modal-btn" class="btn btn-secondary">Ver Aprendidas</button>
                    </div>
                </section>
            </div>

            <div class="right-column">
                 <h2 class="column-title">Mi Bosque Ling√º√≠stico</h2>
                 <section id="tree-section" class="text-center flex flex-col flex-grow tree-section-container">
                    <h2 class="section-title text-[var(--duo-green)]">Tu √Årbol de Palabras</h2>
                    <div id="tree-display" class="tree-display">
                        </div>
                    <p id="tree-level-text">Nivel: Semilla</p> <div class="mt-2 button-group"> <button id="use-fertilizer-btn" class="btn btn-secondary w-full sm:w-auto">Usar Fertilizante</button>
                    </div>
                </section>

                <section class="bottom-section">
                    <h2 class="section-title text-[var(--duo-blue)]">Progreso</h2>
                    <div class="button-group">
                         <button id="export-progress-btn" class="btn btn-tertiary">Exportar</button>
                         <button id="import-progress-btn" class="btn btn-tertiary">Importar</button>
                         <input type="file" id="import-progress-input" accept=".json, .enc">
                    </div>
                    <div id="import-export-feedback" class="feedback text-center mt-1.5"></div> 
                </section>
            </div>
        </div>
    </div>

    <div id="add-card-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Nueva Palabra</h3>
            <label for="new-question">Palabra en Ingl√©s:</label>
            <input type="text" id="new-question" class="input-field w-full" placeholder="Ej: Hello">
            <label for="new-answer">Traducci√≥n al Espa√±ol:</label>
            <input type="text" id="new-answer" class="input-field w-full" placeholder="Ej: Hola">
            <div id="add-card-feedback" class="feedback text-center"></div>
            <div class="flex justify-end space-x-2 mt-3"> 
                <button id="save-card-btn" class="btn btn-primary btn-sm">Guardar</button>
                <button id="cancel-add-card-btn" class="btn bg-slate-300 hover:bg-slate-400 text-slate-800 btn-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="delete-card-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Eliminar Palabra</h3>
            <div id="delete-card-list-container" class="my-2 max-h-48 overflow-y-auto p-2 border border-[var(--duo-gray-light)] rounded-md"> {/* Reduced my, max-h */}
                <p id="no-cards-to-delete-msg" class="text-[var(--duo-gray-dark)] text-sm hidden">No hay palabras para eliminar.</p>
            </div>
            <div id="delete-feedback" class="feedback text-center"></div>
            <div class="flex justify-end space-x-2 mt-3"> 
                <button id="confirm-delete-card-btn" class="btn btn-danger btn-sm">Eliminar</button>
                <button id="cancel-delete-card-btn" class="btn bg-slate-300 hover:bg-slate-400 text-slate-800 btn-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="review-learned-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Palabras Aprendidas</h3>
            <div id="review-learned-list-container" class="my-2 max-h-52 overflow-y-auto p-2 border border-[var(--duo-gray-light)] rounded-md"> {/* Reduced my, max-h */}
                 <p id="no-learned-cards-msg" class="text-[var(--duo-gray-dark)] text-sm hidden">A√∫n no has marcado ninguna palabra como aprendida.</p>
            </div>
            <div id="review-modal-feedback" class="feedback text-center"></div>
            <div class="flex justify-end mt-3"> 
                <button id="close-review-learned-btn" class="btn bg-slate-300 hover:bg-slate-400 text-slate-800 btn-sm">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Tienda del √Årbol</h3>
            <div id="shop-feedback" class="feedback text-center"></div>
            <div class="space-y-2 my-3"> 
                <div class="p-2.5 border border-[var(--duo-gray-light)] rounded-lg bg-[var(--duo-gray-lightest)]"> 
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-sm text-[var(--duo-text-dark)]">Fertilizante M√°gico</h4>
                            <p class="text-xs text-[var(--duo-gray-dark)]">Costo: <span id="fertilizer-shop-cost-display">10</span> Puntos ‚ú®</p>
                        </div>
                        <button id="buy-fertilizer-shop-btn" class="btn btn-primary btn-sm">Comprar</button>
                    </div>
                </div>
                 <div class="p-2.5 border border-[var(--duo-gray-light)] rounded-lg bg-[var(--duo-gray-lightest)]"> 
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-sm text-[var(--duo-text-dark)]">1 Manzana Dorada üçé</h4>
                            <p class="text-xs text-[var(--duo-gray-dark)]">Costo: <span id="apple-shop-cost-display">100</span> Puntos</p>
                        </div>
                        <button id="buy-apple-shop-btn" class="btn btn-primary btn-sm">Comprar</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-3"> 
                <button id="close-shop-btn" class="btn bg-slate-300 hover:bg-slate-400 text-slate-800 btn-sm">Cerrar Tienda</button>
            </div>
        </div>
    </div>

    <script>
        // --- Variables del Juego ---
        let flashcards = [];
        let learnedFlashcards = [];
        let currentCardIndex = 0;
        let score = 0;
        let fertilizerCount = 0;
        let treeLevel = 0;
        let applesCount = 0;
        let applesPerDay = 0;
        let lastAppleGenerationTime = Date.now();
        let appleCountdownInterval = null;

        // --- Constantes del Juego ---
        const POINTS_PER_CORRECT_ANSWER = 10;
        const POINTS_FOR_LEARNED_WORD = 20;
        const DEFAULT_FLASHCARDS = [
            { question: "Hello", answer: "Hola" }, { question: "Goodbye", answer: "Adi√≥s" },
            { question: "Thank you", answer: "Gracias" }, { question: "Please", answer: "Por favor" },
            { question: "Yes", answer: "S√≠" }, { question: "No", answer: "No" },
            { question: "Friend", answer: "Amigo" }, { question: "Love", answer: "Amor" }
        ];
        const CHECK_APPLES_INTERVAL = 60 * 1000; // 1 minuto
        const FERTILIZER_SHOP_COST = 10;
        const APPLE_SHOP_COST = 100;
        const TREE_LEVEL_DATA = [ // Aseg√∫rate de que los GIFs existen en una carpeta 'gifs/' relativa al HTML
            { name: 'Semilla',         gifName: 'gif_1.gif', fertilizerToNext: 5,   applesPerDay: 0 },
            { name: 'Brote',           gifName: 'gif_2.gif', fertilizerToNext: 10,  applesPerDay: 0 },
            { name: '√Årbol Peque√±o',   gifName: 'gif_3.gif', fertilizerToNext: 20,  applesPerDay: 1 },
            { name: '√Årbol Mediano',   gifName: 'gif_4.gif', fertilizerToNext: 40,  applesPerDay: 2 },
            { name: '√Årbol M√¨stico',    gifName: 'gif_5.gif', fertilizerToNext: 80,  applesPerDay: 4 },
            { name: '√Årbol Divino',   gifName: 'gif_6.gif', fertilizerToNext: 160, applesPerDay: 8 }
       
        ];
        const MAX_TREE_LEVEL_INDEX = TREE_LEVEL_DATA.length - 1;

        // --- Constantes de Encriptaci√≥n ---
        const ENCRYPTION_KEY_STRING = "miClaveSuperSecreta1234567890!";
        let cryptoKey;

        // --- Elementos del DOM ---
        const questionTextEl = document.getElementById('question-text');
        const answerInputEl = document.getElementById('answer-input');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const learnedBtn = document.getElementById('learned-btn');
        const nextCardBtn = document.getElementById('next-card-btn');
        const feedbackTextEl = document.getElementById('feedback-text');
        const scoreEl = document.getElementById('score');
        const fertilizerCountEl = document.getElementById('fertilizer-count');
        const treeDisplayEl = document.getElementById('tree-display');
        const treeLevelTextEl = document.getElementById('tree-level-text');
        const useFertilizerBtn = document.getElementById('use-fertilizer-btn');
        const applesCountEl = document.getElementById('apples-count');
        const applesPerDayEl = document.getElementById('apples-per-day');
        const appleCountdownEl = document.getElementById('apple-countdown');
        const showAddCardModalBtn = document.getElementById('show-add-card-modal-btn');
        const addCardModal = document.getElementById('add-card-modal');
        const newQuestionInput = document.getElementById('new-question');
        const newAnswerInput = document.getElementById('new-answer');
        const saveCardBtn = document.getElementById('save-card-btn');
        const cancelAddCardBtn = document.getElementById('cancel-add-card-btn');
        const addCardFeedbackEl = document.getElementById('add-card-feedback');
        const showDeleteCardModalBtn = document.getElementById('show-delete-card-modal-btn');
        const deleteCardModal = document.getElementById('delete-card-modal');
        const deleteCardListContainerEl = document.getElementById('delete-card-list-container');
        const noCardsToDeleteMsgEl = document.getElementById('no-cards-to-delete-msg');
        const confirmDeleteCardBtn = document.getElementById('confirm-delete-card-btn');
        const cancelDeleteCardBtn = document.getElementById('cancel-delete-card-btn');
        const deleteFeedbackEl = document.getElementById('delete-feedback');
        const reviewLearnedModal = document.getElementById('review-learned-modal');
        const reviewLearnedListContainerEl = document.getElementById('review-learned-list-container');
        const noLearnedCardsMsgEl = document.getElementById('no-learned-cards-msg');
        const closeReviewLearnedBtn = document.getElementById('close-review-learned-btn');
        const reviewModalFeedbackEl = document.getElementById('review-modal-feedback');
        const openShopBtn = document.getElementById('open-shop-btn');
        const shopModal = document.getElementById('shop-modal');
        const closeShopBtn = document.getElementById('close-shop-btn');
        const buyFertilizerShopBtn = document.getElementById('buy-fertilizer-shop-btn');
        const buyAppleShopBtn = document.getElementById('buy-apple-shop-btn');
        const shopFeedbackEl = document.getElementById('shop-feedback');
        const fertilizerShopCostDisplayEl = document.getElementById('fertilizer-shop-cost-display');
        const appleShopCostDisplayEl = document.getElementById('apple-shop-cost-display');
        const exportProgressBtn = document.getElementById('export-progress-btn');
        const importProgressBtn = document.getElementById('import-progress-btn');
        const importProgressInput = document.getElementById('import-progress-input');
        const importExportFeedbackEl = document.getElementById('import-export-feedback');
        const showReviewLearnedModalBtn = document.getElementById('show-review-learned-modal-btn'); // Nueva referencia

        // --- Funciones de Encriptaci√≥n/Decriptaci√≥n ---
        async function initCryptoKey() {
            try {
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", new TextEncoder().encode(ENCRYPTION_KEY_STRING.slice(0, 32)),
                    { name: "PBKDF2" }, false, ["deriveKey"]
                );
                const salt = new TextEncoder().encode("someFixedSaltValue");
                cryptoKey = await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                    keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
                );
                // console.log("CryptoKey inicializada."); // Comentado para producci√≥n
            } catch (error) {
                console.error("Error al inicializar CryptoKey:", error);
                showTemporaryFeedback(importExportFeedbackEl, "Error de criptograf√≠a al iniciar.", "incorrect", 5000);
                [exportProgressBtn, importProgressBtn].forEach(btn => {
                    btn.disabled = true; btn.classList.add('btn-disabled');
                });
            }
        }

        async function encryptData(plaintext) {
            if (!cryptoKey) {
                showTemporaryFeedback(importExportFeedbackEl, "Error: Clave de encriptaci√≥n no lista.", "incorrect", 3000); return null;
            }
            try {
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encodedText = new TextEncoder().encode(plaintext);
                const ciphertext = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, cryptoKey, encodedText);
                const ivBase64 = btoa(String.fromCharCode.apply(null, iv));
                const ciphertextBase64 = btoa(String.fromCharCode.apply(null, new Uint8Array(ciphertext)));
                return { iv: ivBase64, ciphertext: ciphertextBase64 };
            } catch (error) {
                console.error("Error encriptando:", error);
                showTemporaryFeedback(importExportFeedbackEl, "Error al encriptar datos.", "incorrect", 3000); return null;
            }
        }

        async function decryptData(ciphertextBase64, ivBase64) {
            if (!cryptoKey) {
                showTemporaryFeedback(importExportFeedbackEl, "Error: Clave de decriptaci√≥n no lista.", "incorrect", 3000); return null;
            }
            try {
                const iv = Uint8Array.from(atob(ivBase64), c => c.charCodeAt(0));
                const ciphertext = Uint8Array.from(atob(ciphertextBase64), c => c.charCodeAt(0)).buffer;
                const decryptedBuffer = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, cryptoKey, ciphertext);
                return new TextDecoder().decode(decryptedBuffer);
            } catch (error) {
                console.error("Error desencriptando:", error);
                showTemporaryFeedback(importExportFeedbackEl, "Error al desencriptar. ¬øArchivo o clave incorrectos?", "incorrect", 4000); return null;
            }
        }

        // --- Funciones del Juego (Export/Import) ---
        async function exportProgress() {
            clearFeedback(importExportFeedbackEl);
            const gameData = { flashcards, learnedFlashcards, currentCardIndex, score, fertilizerCount, treeLevel, applesCount, applesPerDay, lastAppleGenerationTime };
            const jsonData = JSON.stringify(gameData);
            const encryptedPayload = await encryptData(jsonData);
            if (!encryptedPayload) {
                showTemporaryFeedback(importExportFeedbackEl, "Fallo la encriptaci√≥n. No se pudo exportar.", "incorrect", 3000);
                return;
            }
            const dataToExport = JSON.stringify(encryptedPayload);
            const blob = new Blob([dataToExport], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "flashcards_progress_encrypted.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showTemporaryFeedback(importExportFeedbackEl, "Progreso exportado y encriptado.", "correct", 3000);
        }

        function triggerImport() {
            clearFeedback(importExportFeedbackEl);
            importProgressInput.click();
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) {
                showTemporaryFeedback(importExportFeedbackEl, "No se seleccion√≥ archivo.", "info", 3000);
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const fileContent = e.target.result;
                    const encryptedPayload = JSON.parse(fileContent);
                    if (!encryptedPayload.iv || !encryptedPayload.ciphertext) {
                        throw new Error("Formato de archivo encriptado inv√°lido.");
                    }
                    const decryptedJson = await decryptData(encryptedPayload.ciphertext, encryptedPayload.iv);
                    if (!decryptedJson) { return; }
                    const importedData = JSON.parse(decryptedJson);
                    if (typeof importedData.score !== 'number' || !Array.isArray(importedData.flashcards)) {
                        throw new Error("Datos importados inv√°lidos o corruptos.");
                    }
                    flashcards = importedData.flashcards || DEFAULT_FLASHCARDS.slice();
                    learnedFlashcards = importedData.learnedFlashcards || [];
                    currentCardIndex = importedData.currentCardIndex || 0;
                    score = importedData.score || 0;
                    fertilizerCount = importedData.fertilizerCount || 0;
                    treeLevel = importedData.treeLevel || 0;
                    applesCount = importedData.applesCount || 0;
                    lastAppleGenerationTime = importedData.lastAppleGenerationTime || Date.now();
                    saveGameData();
                    initGameVisuals();
                    showTemporaryFeedback(importExportFeedbackEl, "Progreso importado exitosamente.", "correct", 4000);
                } catch (error) {
                    console.error("Error importando progreso:", error);
                    showTemporaryFeedback(importExportFeedbackEl, `Error al importar: ${error.message}`, "incorrect", 5000);
                } finally {
                    importProgressInput.value = "";
                }
            };
            reader.onerror = () => {
                showTemporaryFeedback(importExportFeedbackEl, "Error al leer el archivo.", "incorrect", 3000);
            };
            reader.readAsText(file);
        }

        // --- Funciones Principales del Juego ---
        function displayCard() {
            if (flashcards.length === 0) {
                handleNoCardsState();
                return;
            }
            if (currentCardIndex >= flashcards.length || currentCardIndex < 0) {
                currentCardIndex = 0;
            }
            questionTextEl.textContent = flashcards[currentCardIndex].question;
            answerInputEl.value = "";
            answerInputEl.focus();
            clearFeedback(feedbackTextEl);
            checkAnswerBtn.classList.remove('hidden');
            checkAnswerBtn.disabled = false;
            learnedBtn.classList.add('hidden');
            nextCardBtn.classList.add('hidden');
        }

        function handleNoCardsState() {
            questionTextEl.textContent = "¬°No hay palabras! A√±ade algunas para empezar.";
            answerInputEl.value = "";
            answerInputEl.disabled = true;
            checkAnswerBtn.classList.add('hidden');
            learnedBtn.classList.add('hidden');
            nextCardBtn.classList.add('hidden');
            showTemporaryFeedback(feedbackTextEl, "Usa 'A√±adir Palabra' para crear tus tarjetas.", "info", 0);
        }

        function checkAnswer() {
            if (flashcards.length === 0) return;
            const userAnswer = answerInputEl.value.trim().toLowerCase();
            const correctAnswer = flashcards[currentCardIndex].answer.toLowerCase();
            checkAnswerBtn.classList.add('hidden');
            nextCardBtn.classList.remove('hidden');
            if (userAnswer === correctAnswer) {
                showTemporaryFeedback(feedbackTextEl, "¬°Correcto! üéâ", "correct", 2000);
                score += POINTS_PER_CORRECT_ANSWER;
                if (learnedFlashcards.some(card => card.question.toLowerCase() === flashcards[currentCardIndex].question.toLowerCase())) {
                    score += Math.floor(POINTS_FOR_LEARNED_WORD / 2);
                }
                updateScore();
                learnedBtn.classList.remove('hidden');
            } else {
                showTemporaryFeedback(feedbackTextEl, `Respuesta correcta: ${flashcards[currentCardIndex].answer}`, "incorrect", 3000);
                learnedBtn.classList.add('hidden');
            }
            nextCardBtn.focus();
            saveGameData();
        }

        function markAsLearned() {
            if (flashcards.length === 0) return;
            const cardToLearn = flashcards[currentCardIndex];
            if (learnedFlashcards.findIndex(card => card.question.toLowerCase() === cardToLearn.question.toLowerCase()) === -1) {
                learnedFlashcards.push(cardToLearn);
                score += POINTS_FOR_LEARNED_WORD;
                showTemporaryFeedback(feedbackTextEl, `"${cardToLearn.question}" marcada como aprendida. +${POINTS_FOR_LEARNED_WORD} pts!`, "info", 2500);
            } else {
                showTemporaryFeedback(feedbackTextEl, `"${cardToLearn.question}" ya estaba marcada como aprendida.`, "info", 2500);
            }
            flashcards.splice(currentCardIndex, 1);
            updateScore();
            saveGameData();
            checkAnswerBtn.classList.add('hidden');
            learnedBtn.classList.add('hidden');
            nextCardBtn.classList.remove('hidden');
            nextCardBtn.focus();
            if (flashcards.length === 0) {
                handleNoCardsState();
            } else {
                if (currentCardIndex >= flashcards.length) {
                    currentCardIndex = 0;
                }
                displayCard();
            }
        }

        function moveToNextCard(shuffleDeckIfNeeded = true) {
            if (flashcards.length === 0) {
                handleNoCardsState();
                return;
            }
            currentCardIndex++;
            if (currentCardIndex >= flashcards.length) {
                currentCardIndex = 0;
                if (shuffleDeckIfNeeded && flashcards.length > 1) {
                    shuffleFlashcards();
                    showTemporaryFeedback(feedbackTextEl, "¬°Mazo barajado para la siguiente ronda!", "info", 1500);
                }
            }
            displayCard();
            saveGameData();
        }

        function shuffleFlashcards() {
            for (let i = flashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
            }
        }

        // --- Funciones de UI y Estado ---
        function updateScore() { scoreEl.textContent = score; }
        function updateFertilizerCount() {
            fertilizerCountEl.textContent = fertilizerCount;
            const currentLevelData = TREE_LEVEL_DATA[treeLevel];
            useFertilizerBtn.disabled = treeLevel >= MAX_TREE_LEVEL_INDEX ||
                                       (treeLevel < MAX_TREE_LEVEL_INDEX && fertilizerCount < currentLevelData.fertilizerToNext);
            useFertilizerBtn.classList.toggle('btn-disabled', useFertilizerBtn.disabled);
        }
        function updateApplesCount() { applesCountEl.textContent = `${applesCount} üçé`; }
        function updateApplesPerDay() { applesPerDayEl.textContent = `${applesPerDay} / d√≠a`; }

        function updateTreeVisual() {
            const currentLevelData = TREE_LEVEL_DATA[treeLevel];
            const gifPath = `gifs/${currentLevelData.gifName}`; // Ajusta esta ruta si tus gifs est√°n en otro lugar
            treeDisplayEl.innerHTML = `<img src="${gifPath}" alt="[Imagen de ${currentLevelData.name}]" class="tree-gif mx-auto">`;
            treeLevelTextEl.textContent = `Nivel: ${currentLevelData.name}`;
            applesPerDay = currentLevelData.applesPerDay;
            updateApplesPerDay();
            if (treeLevel >= MAX_TREE_LEVEL_INDEX) {
                useFertilizerBtn.textContent = "¬°√Årbol Maximizado!";
                useFertilizerBtn.disabled = true;
            } else {
                useFertilizerBtn.textContent = `Crecer (${currentLevelData.fertilizerToNext} Fert.)`;
                useFertilizerBtn.disabled = fertilizerCount < currentLevelData.fertilizerToNext;
            }
            useFertilizerBtn.classList.toggle('btn-disabled', useFertilizerBtn.disabled);
        }

        function growTree() {
            if (treeLevel >= MAX_TREE_LEVEL_INDEX) {
                showTemporaryFeedback(feedbackTextEl, "Tu √°rbol ya est√° en el nivel m√°ximo.", "info", 2500);
                return;
            }
            const requiredFertilizer = TREE_LEVEL_DATA[treeLevel].fertilizerToNext;
            if (fertilizerCount >= requiredFertilizer) {
                fertilizerCount -= requiredFertilizer;
                treeLevel++;
                updateTreeVisual();
                updateFertilizerCount();
                showTemporaryFeedback(feedbackTextEl, `¬°Tu √°rbol creci√≥ a ${TREE_LEVEL_DATA[treeLevel].name}!`, "correct", 2500);
                treeDisplayEl.style.transform = 'scale(1.15)';
                setTimeout(() => { treeDisplayEl.style.transform = 'scale(1)'; }, 300);
                saveGameData();
            } else {
                showTemporaryFeedback(feedbackTextEl, `Necesitas ${requiredFertilizer - fertilizerCount} m√°s fertilizante para crecer el √°rbol.`, "info", 3000);
            }
        }

        function checkAndGenerateApples() {
            if (applesPerDay <= 0) {
                updateAppleCountdown();
                return;
            }
            const now = Date.now();
            const timeElapsedMs = now - lastAppleGenerationTime;
            const generationIntervalMs = ((24 * 60 * 60) / applesPerDay) * 1000;
            if (timeElapsedMs >= generationIntervalMs) {
                const applesToGenerate = Math.floor(timeElapsedMs / generationIntervalMs);
                applesCount += applesToGenerate;
                lastAppleGenerationTime += applesToGenerate * generationIntervalMs;
                updateApplesCount();
                showTemporaryFeedback(feedbackTextEl, `¬°Cosechaste ${applesToGenerate} manzana(s) üçé!`, "correct", 2000);
                saveGameData();
            }
            updateAppleCountdown();
        }

        function updateAppleCountdown() {
            if (appleCountdownInterval) clearInterval(appleCountdownInterval);
            if (applesPerDay <= 0) {
                appleCountdownEl.textContent = "--:--:--";
                return;
            }
            appleCountdownInterval = setInterval(() => {
                const now = Date.now();
                const generationIntervalMs = ((24 * 60 * 60) / applesPerDay) * 1000;
                const timeSinceLastApple = now - lastAppleGenerationTime;
                let timeToNextAppleMs = generationIntervalMs - (timeSinceLastApple % generationIntervalMs);
                if (timeToNextAppleMs <= 1000 && timeToNextAppleMs > 0) {
                     appleCountdownEl.textContent = "¬°Ahora!";
                     if(timeSinceLastApple >= generationIntervalMs) checkAndGenerateApples();
                     return;
                }
                if (timeToNextAppleMs <=0) timeToNextAppleMs = generationIntervalMs;
                const h = String(Math.floor((timeToNextAppleMs / (1000 * 60 * 60)) % 24)).padStart(2, '0');
                const m = String(Math.floor((timeToNextAppleMs / (1000 * 60)) % 60)).padStart(2, '0');
                const s = String(Math.floor((timeToNextAppleMs / 1000) % 60)).padStart(2, '0');
                appleCountdownEl.textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        function saveGameData() {
            const gameData = {
                flashcards, learnedFlashcards, currentCardIndex, score,
                fertilizerCount, treeLevel, applesCount,
                lastAppleGenerationTime
            };
            localStorage.setItem('flashcardGameData', JSON.stringify(gameData));
        }

        function loadGameData() {
            const savedData = localStorage.getItem('flashcardGameData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    flashcards = parsedData.flashcards || DEFAULT_FLASHCARDS.slice();
                    learnedFlashcards = parsedData.learnedFlashcards || [];
                    currentCardIndex = parsedData.currentCardIndex || 0;
                    score = parsedData.score || 0;
                    fertilizerCount = parsedData.fertilizerCount || 0;
                    treeLevel = parsedData.treeLevel || 0;
                    applesCount = parsedData.applesCount || 0;
                    lastAppleGenerationTime = parsedData.lastAppleGenerationTime || Date.now();
                    if (flashcards.length === 0 && DEFAULT_FLASHCARDS.length > 0) {
                        flashcards = DEFAULT_FLASHCARDS.slice();
                        shuffleFlashcards();
                    }
                } catch (e) {
                    console.error("Error parseando datos guardados, reseteando a default:", e);
                    resetToDefaults();
                }
            } else {
                resetToDefaults();
            }
        }

        function resetToDefaults() {
            flashcards = DEFAULT_FLASHCARDS.slice();
            shuffleFlashcards();
            learnedFlashcards = [];
            currentCardIndex = 0;
            score = 0;
            fertilizerCount = 0;
            treeLevel = 0;
            applesCount = 0;
            lastAppleGenerationTime = Date.now();
        }

        function updateAllStats() {
            updateScore();
            updateFertilizerCount();
            updateApplesCount();
            updateTreeVisual();
        }

        // --- Funciones de Modales ---
        function openModal(modalElement) { modalElement.classList.remove('hidden'); }
        function closeModal(modalElement) { modalElement.classList.add('hidden'); }

        function clearFeedback(element, delay = 0) {
            const baseClass = element.className.split(' ').filter(cls => cls === 'feedback' || cls === 'text-center' || cls.startsWith('mt-') || cls.startsWith('h-')).join(' ');
            if (delay > 0) {
                setTimeout(() => { element.textContent = ''; element.className = baseClass; }, delay);
            } else {
                element.textContent = '';
                element.className = baseClass;
            }
        }

        function showTemporaryFeedback(element, message, type = 'info', duration = 3000) {
            clearFeedback(element);
            const baseClass = element.className.split(' ').filter(cls => cls === 'feedback' || cls === 'text-center' || cls.startsWith('mt-') || cls.startsWith('h-')).join(' ');
            element.textContent = message;
            element.classList.add(type);
            if (duration > 0) {
                setTimeout(() => clearFeedback(element), duration);
            }
        }

        // Modal: A√±adir Palabra
        showAddCardModalBtn.addEventListener('click', () => {
            newQuestionInput.value = ''; newAnswerInput.value = '';
            clearFeedback(addCardFeedbackEl);
            openModal(addCardModal);
            newQuestionInput.focus();
        });
        cancelAddCardBtn.addEventListener('click', () => closeModal(addCardModal));
        saveCardBtn.addEventListener('click', () => {
            const newQ = newQuestionInput.value.trim();
            const newA = newAnswerInput.value.trim();
            if (newQ && newA) {
                if (flashcards.some(c => c.question.toLowerCase() === newQ.toLowerCase()) ||
                    learnedFlashcards.some(c => c.question.toLowerCase() === newQ.toLowerCase())) {
                    showTemporaryFeedback(addCardFeedbackEl, "Esa palabra ya existe en tus mazos.", "incorrect", 2500);
                    return;
                }
                flashcards.push({ question: newQ, answer: newA });
                saveGameData();
                showTemporaryFeedback(addCardFeedbackEl, "¬°Palabra a√±adida con √©xito!", "correct", 1500);
                newQuestionInput.value = ''; newAnswerInput.value = '';
                newQuestionInput.focus();
                if (flashcards.length === 1 && questionTextEl.textContent.startsWith("¬°No hay palabras!")) {
                    displayCard();
                    answerInputEl.disabled = false;
                    clearFeedback(feedbackTextEl);
                }
            } else {
                showTemporaryFeedback(addCardFeedbackEl, "Ambos campos son obligatorios.", "incorrect", 2000);
            }
        });

        // Modal: Eliminar Palabra
        function populateDeleteCardList() {
            deleteCardListContainerEl.innerHTML = '';
            clearFeedback(deleteFeedbackEl);
            const cardsToDeleteFrom = [...flashcards, ...learnedFlashcards];
            if (cardsToDeleteFrom.length === 0) {
                noCardsToDeleteMsgEl.classList.remove('hidden');
                confirmDeleteCardBtn.disabled = true;
                confirmDeleteCardBtn.classList.add('btn-disabled');
                return;
            }
            noCardsToDeleteMsgEl.classList.add('hidden');
            confirmDeleteCardBtn.disabled = false;
            confirmDeleteCardBtn.classList.remove('btn-disabled');
            cardsToDeleteFrom.sort((a, b) => a.question.localeCompare(b.question)).forEach((card, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center p-1.5 hover:bg-gray-50 rounded';
                const isLearned = learnedFlashcards.some(lc => lc.question.toLowerCase() === card.question.toLowerCase());
                listItem.innerHTML = `
                    <input type="checkbox" id="delete-card-${index}" value="${card.question}" class="mr-2 rounded border-gray-300 text-[var(--duo-blue)] focus:ring-[var(--duo-blue)] h-4 w-4">
                    <label for="delete-card-${index}" class="flex-grow text-sm text-[var(--duo-text-dark)] cursor-pointer">
                        ${card.question} - ${card.answer}
                        ${isLearned ? '<span class="text-xs text-[var(--duo-green)] ml-1 font-semibold">(Aprendida)</span>' : ''}
                    </label>`;
                deleteCardListContainerEl.appendChild(listItem);
            });
        }
        showDeleteCardModalBtn.addEventListener('click', () => { populateDeleteCardList(); openModal(deleteCardModal); });
        cancelDeleteCardBtn.addEventListener('click', () => closeModal(deleteCardModal));
        confirmDeleteCardBtn.addEventListener('click', () => {
            const checkboxes = deleteCardListContainerEl.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                showTemporaryFeedback(deleteFeedbackEl, "Selecciona al menos una palabra para eliminar.", "incorrect", 2500);
                return;
            }
            const questionsToDelete = Array.from(checkboxes).map(cb => cb.value.toLowerCase());
            let deletedCount = 0;
            const initialFlashcardsLength = flashcards.length;
            flashcards = flashcards.filter(card => {
                if (questionsToDelete.includes(card.question.toLowerCase())) {
                    return false;
                }
                return true;
            });
            deletedCount += (initialFlashcardsLength - flashcards.length);
            const initialLearnedLength = learnedFlashcards.length;
            learnedFlashcards = learnedFlashcards.filter(card => !questionsToDelete.includes(card.question.toLowerCase()));
            deletedCount += (initialLearnedLength - learnedFlashcards.length);
            if (deletedCount > 0) {
                saveGameData();
                showTemporaryFeedback(deleteFeedbackEl, `${deletedCount} palabra(s) eliminada(s) permanentemente.`, "correct", 2000);
                if (currentCardIndex >= flashcards.length) {
                    currentCardIndex = Math.max(0, flashcards.length - 1);
                }
                if (flashcards.length === 0) {
                    handleNoCardsState();
                } else {
                    displayCard();
                }
            } else {
                showTemporaryFeedback(deleteFeedbackEl, "No se eliminaron palabras. ¬øYa estaban eliminadas?", "info", 2500);
            }
            populateDeleteCardList();
             if (deleteCardListContainerEl.querySelectorAll('input[type="checkbox"]').length === 0) {
                 noCardsToDeleteMsgEl.classList.remove('hidden');
                 confirmDeleteCardBtn.disabled = true; confirmDeleteCardBtn.classList.add('btn-disabled');
            }
        });

        // Modal: Revisar Aprendidas
        function populateReviewLearnedList() {
            reviewLearnedListContainerEl.innerHTML = '';
            clearFeedback(reviewModalFeedbackEl);
            if (learnedFlashcards.length === 0) {
                noLearnedCardsMsgEl.classList.remove('hidden');
                return;
            }
            noLearnedCardsMsgEl.classList.add('hidden');
            learnedFlashcards.sort((a, b) => a.question.localeCompare(b.question)).forEach((card) => {
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center justify-between p-1.5 hover:bg-gray-50 rounded';
                listItem.innerHTML = `
                    <span class="text-sm text-[var(--duo-text-dark)]">${card.question} - ${card.answer}</span>
                    <button data-question="${card.question}" class="btn btn-danger btn-sm remove-learned-btn !py-1 !px-2 !text-xs">Olvidar</button>`;
                reviewLearnedListContainerEl.appendChild(listItem);
            });
            reviewLearnedListContainerEl.querySelectorAll('.remove-learned-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const questionToRemove = e.target.dataset.question;
                    const cardIndexInLearned = learnedFlashcards.findIndex(c => c.question.toLowerCase() === questionToRemove.toLowerCase());
                    if (cardIndexInLearned > -1) {
                        const removedCard = learnedFlashcards.splice(cardIndexInLearned, 1)[0];
                        if (!flashcards.some(fc => fc.question.toLowerCase() === removedCard.question.toLowerCase())) {
                            flashcards.push(removedCard);
                            shuffleFlashcards();
                        }
                        saveGameData();
                        populateReviewLearnedList();
                        showTemporaryFeedback(reviewModalFeedbackEl, `"${questionToRemove}" movida de nuevo al mazo principal.`, "info", 2000);
                        if (flashcards.length > 0 && questionTextEl.textContent.startsWith("¬°No hay palabras!")) {
                             displayCard();
                             answerInputEl.disabled = false;
                             clearFeedback(feedbackTextEl);
                        }
                    }
                });
            });
        }
        closeReviewLearnedBtn.addEventListener('click', () => closeModal(reviewLearnedModal));

        // Modal: Tienda
        function updateShopCosts() {
            fertilizerShopCostDisplayEl.textContent = FERTILIZER_SHOP_COST;
            appleShopCostDisplayEl.textContent = APPLE_SHOP_COST;
        }
        openShopBtn.addEventListener('click', () => {
            clearFeedback(shopFeedbackEl);
            updateShopCosts();
            openModal(shopModal);
        });
        closeShopBtn.addEventListener('click', () => closeModal(shopModal));
        buyFertilizerShopBtn.addEventListener('click', () => {
            if (score >= FERTILIZER_SHOP_COST) {
                score -= FERTILIZER_SHOP_COST;
                fertilizerCount++;
                updateScore();
                updateFertilizerCount();
                saveGameData();
                showTemporaryFeedback(shopFeedbackEl, "¬°Fertilizante comprado! √ösalo para crecer tu √°rbol.", "correct", 2000);
            } else {
                showTemporaryFeedback(shopFeedbackEl, "Puntos insuficientes para comprar fertilizante.", "incorrect", 2000);
            }
        });
        buyAppleShopBtn.addEventListener('click', () => {
            if (score >= APPLE_SHOP_COST) {
                score -= APPLE_SHOP_COST;
                applesCount++;
                updateScore();
                updateApplesCount();
                saveGameData();
                showTemporaryFeedback(shopFeedbackEl, "¬°Manzana comprada! üçé Deliciosa.", "correct", 2000);
            } else {
                showTemporaryFeedback(shopFeedbackEl, "Puntos insuficientes para comprar una manzana.", "incorrect", 2000);
            }
        });

        // --- Event Listeners Globales ---
        checkAnswerBtn.addEventListener('click', checkAnswer);
        answerInputEl.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                if (!checkAnswerBtn.classList.contains('hidden')) {
                    checkAnswer();
                } else if (!nextCardBtn.classList.contains('hidden')) {
                    moveToNextCard();
                }
            }
        });
        learnedBtn.addEventListener('click', markAsLearned);
        nextCardBtn.addEventListener('click', () => moveToNextCard());
        useFertilizerBtn.addEventListener('click', growTree);
        exportProgressBtn.addEventListener('click', exportProgress);
        importProgressBtn.addEventListener('click', triggerImport);
        importProgressInput.addEventListener('change', handleImportFile);
        showReviewLearnedModalBtn.addEventListener('click', () => { // Nuevo Event Listener
            populateReviewLearnedList();
            openModal(reviewLearnedModal);
        });

        // --- Inicializaci√≥n del Juego ---
        function initGameVisuals() {
            checkAndGenerateApples();
            if (flashcards.length > 0) {
                if (currentCardIndex >= flashcards.length || currentCardIndex < 0) currentCardIndex = 0;
                displayCard();
                answerInputEl.disabled = false;
                clearFeedback(feedbackTextEl);
            } else {
                handleNoCardsState();
            }
            updateAllStats();
        }

        async function initGame() {
            await initCryptoKey();
            loadGameData();
            initGameVisuals();
            if (!window.appleCheckIntervalId) {
                 window.appleCheckIntervalId = setInterval(checkAndGenerateApples, CHECK_APPLES_INTERVAL);
            }
            updateAppleCountdown();
        }

        window.onload = initGame;
    </script>
</body>
</html>